<CONTENT VERSION="1.0" LANG="fr" CHARSET="utf-8" />

/**
 * Intialisation.
 */
<DEFMACRO NAME="INIT">
	<LET VAR="chemin_logo" GLOBAL="1">tpl/images/logo.jpg</LET>
</DEFMACRO>

/**
 * Ouverture de la page.
 * @param {string} [titre_page] - Titre de la page à ajouter à la balise title.
 */
<DEFFUNC NAME="PAGE_START" OPTIONAL="titre_page">
	<!DOCTYPE html>
	<html lang="fr">
		<head>
			<meta charset="utf-8">
			<title><IF COND="[#TITRE_PAGE]">[#TITRE_PAGE] – </IF>[#OPTIONS.METADONNEESSITE.TITRESITE]</title>
			<MACRO NAME="METAS" />
			<MACRO NAME="CSS" />
		</head>
		<LET VAR="tpl_class"/>tpl-<IF COND="[#TPL]">[#TPL]<ELSE />home</IF></LET>
		<body class="[#TPL_CLASS]">
			<MACRO NAME="MAIN_HEADER" />
			<FUNC NAME="NAV" IDENTIFIER="menu-principal" CLASSNAME="main-nav" />
			<div class="main-container">
</DEFFUNC>

/**
 * Fermeture de la page.
 */
<DEFMACRO NAME="PAGE_END">
			</div>
			<MACRO NAME="FOOTER" />
			<MACRO NAME="JS" />
		</body>
	</html>
</DEFMACRO>

/**
 * Métadonnées de la page.
 */
<DEFMACRO NAME="METAS">
	<meta name="generator" content="Lodel [#VERSION]" />
	<meta name="url" content="[%SITEINFOS.URL]" />
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<!--[ keywords / DC.subject ]-->
	<IF COND="[#OPTIONS.METADONNEESSITE.MOTSCLESDUSITE]">
		<meta name="keywords" content="[#OPTIONS.METADONNEESSITE.MOTSCLESDUSITE|textebrut|cleanBadChars|replacequotationmark]" />
		<meta name="DC.subject" content="[#OPTIONS.METADONNEESSITE.MOTSCLESDUSITE|textebrut|cleanBadChars|replacequotationmark]" />
	</IF>

	<!--[ description / DC.description ]-->
	<IF COND="[#OPTIONS.METADONNEESSITE.DESCRIPTIONSITE]">
		<LET VAR="description">[#OPTIONS.METADONNEESSITE.DESCRIPTIONSITE|textebrut|cleanBadChars|replacequotationmark]</LET>
		<meta name="description" content="[#DESCRIPTION]" />
		<meta name="DC.description" content="[#DESCRIPTION]" />
	</IF>

	<!--[ DC.rights ]-->
	<IF COND="[#OPTIONS.METADONNEESSITE.DROITSAUTEUR]">
		<meta name="DC.rights" content="[#OPTIONS.METADONNEESSITE.DROITSAUTEUR|textebrut|cleanBadChars|replacequotationmark]" />
	</IF>
	
	<!--[ Open Graph ]-->
	<meta property="og:title" content="[#OPTIONS.METADONNEESSITE.TITRESITE]" />
	<meta property="og:type" content="website" />
	<meta property="og:url" content="[%SITEINFOS.URL]" />
	<IF COND="[%CHEMIN_LOGO]">
		<meta property="og:image" content="[%CHEMIN_LOGO]" />
	</IF>
</DEFMACRO>

/**
 * Inclusion des CSS.
 */
<DEFMACRO NAME="CSS">
	<!--[ Bootstrap ]-->
	<link href="tpl/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	
	<!--[ Prairial ]-->
	<link href="tpl/css/prairial.css" rel="stylesheet">
</DEFMACRO>

/**
 * Inclusion du JS.
 */
<DEFMACRO NAME="JS">
	<!--[ JQuery ]-->
	<script src="tpl/vendor/jquery-3.4.1.min.js"></script>

	<!--[ Bootstrap ]-->
	<script src="tpl/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

	<!--[ Site ]-->
	<script src="tpl/js/prairial.js"></script>
</DEFMACRO>

/**
 * Bandeau supérieur.
 */
<DEFMACRO NAME="MAIN_HEADER">
	<header class="main-header">
		<div class="container">
			<IF COND="[%CHEMIN_LOGO]">
				<img class="logo" src="[%CHEMIN_LOGO]" alt="[#OPTIONS.METADONNEESSITE.TITRESITE]" />
			</IF>
		</div>
	</header>
</DEFMACRO>

/**
 * Pied de page.
 */
<DEFMACRO NAME="FOOTER">
	<footer class="main-footer">
		<div class="container text-center text-white">
			<div class="row">
				<div class="col-md-4">
					<FUNC NAME="LOGOS" IDENTIFIER="tutelles" />
				</div>
				<div class="col-md-4">
					<FUNC NAME="LOGOS" IDENTIFIER="partenaires" />
				</div>
				<div class="col-md-4">
					<FUNC NAME="NAV" IDENTIFIER="menu-footer" CLASSNAME="footer-nav" />
				</div>
			</div>
		</div>
	</footer>
</DEFMACRO>

/**
 * Insertion d'un menu.
 * @param {string} identifier - Identifiant du menu.
 * @param {string} [classname] - Classe ajoutée à l'élément nav.
 */
<DEFFUNC NAME="NAV" REQUIRED="identifier" OPTIONAL="classname">
	<LET VAR="id_page_courante">[#ID]</LET>
	<LOOP NAME="nav_parent" TABLE="publications" WHERE="type='menu' AND identifier='[#IDENTIFIER]'" SELECT="id" LIMIT="0,1">
		<LOOP NAME="nav_items" TABLE="liensinternes" WHERE="type='elementdemenu' AND idparent='[#ID]'" SELECT="id, titre">
			<BEFORE>
				<nav class="navbar navbar-expand-lg navbar-center [#CLASSNAME]">
					<div class="container">
						<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
							<span class="navbar-toggler-icon"></span>
						</button>
						<div class="collapse navbar-collapse" id="navbarResponsive">
							<ul class="navbar-nav ml-auto-off">
			</BEFORE>

			<DO>
				<LET VAR="cible" /><FUNC NAME="NAV_CIBLE" ID="[#ID]" /></LET>
				<IF COND="[#CIBLE|trim] EQ [#ID_PAGE_COURANTE] OR ([#CIBLE|trim] EQ '.' AND [#ID_PAGE_COURANTE] EQ '0')">
					<LET VAR="active_class">active</LET>
				</IF>
				<li class="nav-item [#ACTIVE_CLASS]">
					<a class="nav-link" href="[#CIBLE|trim]">[#TITRE]</a>
				</li>
			</DO>

			<AFTER>
							</ul>
						</div>
					</div>
				</nav>
			</AFTER>
		</LOOP>
	</LOOP>
</DEFFUNC>

/**
 * Insertion des logos partenaires.
 * @param {sting} identifier - Identifiant de la publication parente.
 */
<DEFFUNC NAME="LOGOS" REQUIRED="identifier" OPTIONAL="classname" >
	<LOOP NAME="logos_parent" TABLE="publications" WHERE="type='annuairedesites' AND identifier='[#IDENTIFIER]'" SELECT="id, titre AS titreparent" LIMIT="0,1" />
		<LOOP NAME="logos" TABLE="liens" WHERE="type='noticedesite' AND idparent='[#ID]'" SELECT="titre, url, vignette" ORDER="rank" />
			<BEFORE>
				<div class="logos [#CLASSNAME]">
					<IF COND="[#TITREPARENT]">
						<h2 class="footer-section-title">[#TITREPARENT]</h2>
					</IF>
			</BEFORE>

			<DO>
				<IF COND="[#URL]">
					<a href="[#URL]"><img class="logos-img" src="[#VIGNETTE]" alt="[#TITRE]" /></a>
				<ELSE />
					<img class="logos-img" src="[#VIGNETTE]" alt="[#TITRE]" />
				</IF>
			</DO>

			<AFTER>
				</div>
			</AFTER>
		</LOOP>
	</LOOP>
</DEFFUNC>

/**
 * Récupérer la cible d'un élément de menu.
 * @param {number} id - ID de l'elementdemenu.
 * Si pas de cible alors on retourne "." pour lier vers l'accueil.
 */
<DEFFUNC NAME="NAV_CIBLE" REQUIRED="ID">
	<LOOP NAME="nav_cible" TABLE="relations" WHERE="nature='cible' AND id1='[#ID]'" SELECT="id2 AS cible" LIMIT="0,1">
		<DO>[#CIBLE|makeurlwithid]</DO>
		<ALTERNATIVE>.</ALTERNATIVE>
	</LOOP>
</DEFFUNC>

/**
 * Contenu de la home.
 */
<DEFMACRO NAME="HOME_MAIN">
	<MACRO NAME="HOME_PRESENTATION" />
	<FUNC NAME="CATALOGUE" MAX="3" TITRE_SECTION="[@REVUES_RECENTES]" />
	<MACRO NAME="HOME_ACTUALITES" />
</DEFMACRO>

/**
 * Présentation du portail sur la home.
 */
<DEFMACRO NAME="HOME_PRESENTATION">
	<LOOP NAME="home_presentation_parent" TABLE="publications" WHERE="type='menu' AND identifier='presentation'" SELECT="id" LIMIT="0,1" />
		<LOOP NAME="home_presentation_elements" TABLE="liensinternes" WHERE="type='elementdemenu' AND idparent='[#ID]'" SELECT="id, titre, description, vignette" ORDER="rank" />
			<BEFORE>
				<section class="presentation">
					<div class="container">
						<div class="jumbotron border my-4">
							<div class="row">
			</BEFORE>

			<DOFIRST>
				<div class="col-md-6">
					<h1 class="jumbotron-h">[#TITRE]</h1>
					<IF COND="[#DESCRIPTION]">
						<p class="lead">[#DESCRIPTION]</p>
					</IF>
					<LET VAR="cible" /><FUNC NAME="NAV_CIBLE" ID="[#ID]" /></LET>
					<IF COND="[#CIBLE|trim] NE '.'">
						<div class="btn btn-outline-primary btn-lg mt-2">
							<a href="[#CIBLE|trim]">[@EN_SAVOIR_PLUS]</a>
						</div>
					</IF>
				</div>
			</DOFIRST>

			<DO>
				<IF COND="[#COUNT] EQ 2">
					<div class="col-md-6">
						<div class="list-group list-group-flush">
				</IF>

				<div class="list-group-item list-group-item-action flex-column align-items-center">
					<LET VAR="cible" /><FUNC NAME="NAV_CIBLE" ID="[#ID]" /></LET>
					<IF COND="[#CIBLE|trim] NE '.'"><a href="[#CIBLE|trim]"></IF>
						<div class="d-flex flex-row w-100 justify-content-center align-items-center">
							<IF COND="[#VIGNETTE]">
								<div class="list-img-container">
									<img class="list-img" src="[#VIGNETTE|vignette(200)]" alt="" />
								</div>
							</IF>
							<div class="list-text">
								<h5 class="mb-1">[#TITRE]</h5>
								<IF COND="[#DESCRIPTION]">
									<p class="mb-1">[#DESCRIPTION]</p>
								</IF>
							</div>
						</div>
					<IF COND="[#CIBLE|trim] NE '.'"></a></IF>
				</div>
				
				<IF COND="[#COUNT] EQ [#NBRESULTS]">
						</div>
					</div>
				</IF>
			</DO>

			<AFTER>
							</div>
						</div>
					</div>
				</section>
			</AFTER>
		</LOOP>
	</LOOP>
</DEFMACRO>

/**
 * Catalogue.
 * @param {string} [max] - Nombre maximum de volumes affichés.
 * @param {boolean} [filtres] - Afficher les filtres dynamiques.
 * @param {boolean} [titre_section] - Titre à afficher avant le catalogue.
 */
<DEFFUNC NAME="CATALOGUE" OPTIONAL="max, filtres, titre_section">
	<LOOP NAME="catalogue_parent" TABLE="publications" WHERE="type='annuairedesites' AND identifier='catalogue'" SELECT="id" LIMIT="0,1" />
		<IF COND="![#MAX]">
			<LET VAR="max" />9999</LET>
		</IF>
		<LOOP NAME="catalogue_issues" TABLE="liens" WHERE="type='noticedesite' AND idparent='[#ID]'" LIMIT="0,[#MAX]" ORDER="rank" />
			<BEFORE>
				<section class="revues">
					<div class="container">
						<IF COND="[#TITRE_SECTION]">
							<h2 class="section-h">[#TITRE_SECTION]</h2>
						</IF>
						<IF COND="[#FILTRES]">
							<MACRO NAME="CATALOGUE_FILTRES" />
						</IF>
						<div class="row revues-container">
			</BEFORE>

			<DO>
				<LET VAR="revue_tags" GLOBAL="1" /></LET>
				<LOOP NAME="catalogue_issue_index" TABLE="entrytypes" WHERE="class = 'filtrescatalogue'" SELECT="id AS idtype"
					ORDER="rank" />
					<LOOP NAME="catalogue_issue_entry" TABLE="entries" SELECT="id" WHERE="idtype = '[#IDTYPE]' AND iddocument = '[#ID]'">
						<IF COND="[%REVUE_TAGS]">
							<LET VAR="revue_tags" GLOBAL="1" />[%REVUE_TAGS],[#ID]</LET>
						<ELSE />
							<LET VAR="revue_tags" GLOBAL="1" />[#ID]</LET>
						</IF>
					</LOOP>
				</LOOP>

				<div class="revue col-md-4" data-tags="[%REVUE_TAGS]">
					<div class="card">
						<IF COND="[#VIGNETTE]">
							<a href="[#URL]"><img class="card-img-top" src="[#VIGNETTE|vignette(700)]" alt="" /></a>
						</IF>
						<div class="card-body">
							<h5 class="card-title">[#TITRE]</h5>
							<IF COND="[#SOUSTITRE]">
								<h6 class="card-subtitle mb-2 text-muted">[#SOUSTITRE]</h6>
							</IF>
							<IF COND="[#TEXTE]">
								<p class="card-text">[#TEXTE]</p>
							</IF>
						</div>
						<div class="card-footer text-center">
							<a href="[#URL]">[@VISITER]</a>
						</div>
					</div>
				</div>
			</DO>

			<AFTER>
						</div>
						<IF COND="[#FILTRES]">
							<div class="revues-aucun-resultat hidden">[@REVUES_AUCUN_RESULTAT]</div>
						</IF>
						<IF COND="[#NBRESULTS] GT [#MAX]">
							<div class="lien-catalogue text-center">
								<a href="./?identifier=catalogue" class="btn btn-lg btn-primary ml-auto mr-auto mt-4">[@CONSULTER_LE_CATALOGUE] &raquo;</a>
							</div>
						</IF>
					</div>
				</section>
			</AFTER>
		</LOOP>
	</LOOP>
</DEFFUNC>

/**
 * Filtres du catalogue.
 */
<DEFMACRO NAME="CATALOGUE_FILTRES">
	<div id="filters" class="filters">
		<nav class="filters-navbar navbar navbar-default justify-content-start">
			<div class="navbar-brand">[@FILTRER]</div>
			<div class="navbar-form navbar-left ">
				<div class="form-group d-flex">
						<LOOP NAME="catalogue_filters_index" TABLE="entrytypes" WHERE="class = 'filtrescatalogue'" SELECT="type, title, id" ORDER="rank" />
							<LOOP NAME="catalogue_filters_entries" TABLE="entries" WHERE="idtype = '[#ID]'" SELECT="id, g_name" ORDER="g_name" />
								<BEFORE>
									<select id="filter-[#TYPE]" name="filter-[#TYPE]" class="form-control filter-control custom-select">
									<option value="">[#TITLE]</option>
								</BEFORE>
								<DO> 
									<option value="[#ID|makeurlwithid]">[#G_NAME]</option>
								</DO>
								<AFTER>
									</select>
								</AFTER>
							</LOOP>
						</LOOP>
						<button id="filter-reset" class="btn btn-link hidden">[@SUPPRIMER_LES_FILTRES]</button>
					</div>
				</div>
		</nav>
	</div>
</DEFMACRO>

/**
 * Actualités affichées sur la home.
 */
<DEFMACRO NAME="HOME_ACTUALITES">	
	<LOOP NAME="home_actualites" TABLE="textessimples" WHERE="type = 'billetactualite' AND (!datedexpiration OR datedexpiration >= CURDATE())" SELECT="id, titre, texte, date, vignette" LIMIT="0,1" ORDER="date DESC" />
		<BEFORE>
			<section class="actus">
				<div class="container">
					<h2 class="section-h">[@ACTUALITES]</h2>
		</BEFORE>

		<DO>
			<div class="row">
				<div class="col-md-6">
					<IF COND="[#VIGNETTE]">
						<img src="[#VIGNETTE|vignette(800)]" class="img-fluid" alt="">
					</IF>
				</div>
				<div class="col-md-6">
					<h3 class="actu-titre">[#TITRE]</h3>
					<IF COND="[#DATE]">
						<div class="actu-date">[#DATE|formateddate("%d %B %Y")]</div>
					</IF>
					<IF COND="[#TEXTE]">
						<p class="lead">[#TEXTE|removetags('p')|cuttext(300)]<IF COND="[#TEXTE|hasbeencut]">… <a href="[#ID|makeurlwithid]">[@LIRE_LA_SUITE]&nbsp;&raquo;</a></IF></p>
					</IF>
				</div>
			</div>
			<MACRO NAME="HOME_ACTUALITES_NEXT" />
		</DO>

		<AFTER>
				</div>
			</section>
		</AFTER>
	</LOOP>
</DEFMACRO>

/**
 * Actualités qui suivent la première.
 */
<DEFMACRO NAME="HOME_ACTUALITES_NEXT">
	<LOOP NAME="home_actualites_next" TABLE="textessimples" WHERE="type = 'billetactualite' AND (!datedexpiration OR datedexpiration >= CURDATE())" SELECT="id, titre, texte, date, vignette" LIMIT="1,2" ORDER="date DESC" />
		<BEFORE>
			<div class="row other-actus">
		</BEFORE>

		<DO>
			<div class="col-md-4">
				<a href="[#ID|makeurlwithid]">
					<IF COND="[#VIGNETTE]">
						<img src="[#VIGNETTE|vignette(600)]" class="img-fluid" alt="">
					</IF>
					<h3 class="actu-titre">[#TITRE]</h3>
					<IF COND="[#DATE]">
						<div class="actu-date">[#DATE|formateddate("%d %B %Y")]</div>
					</IF>
				</a>
			</div>
		</DO>
			
		<AFTER>
				<!--[ Bloc "Toutes les actualités" ]-->
				<div class="col-md-4">
					<a href="./?identifier=actualites">
						<img src="tpl/images/actus-plus.jpg" class="img-fluid" alt="">
						<h3 class="actu-titre">[@TOUTES_LES_ACTUS]</h3>
					</a>
				</div>
			</div>
		</AFTER>
	</LOOP>
</DEFMACRO>

/**
 * Page catalogue.
 */
<DEFMACRO NAME="CATALOGUE_MAIN" >
	<FUNC NAME="CATALOGUE" FILTRES="1" TITRE_SECTION="[#TITRE]" />
</DEFMACRO>